# Unit Spec: LLM H2 → 순서 리스트 변환

## 1. 요구사항 요약

- **목적:** LLM 응답 본문 내 H2(`##`) 구문을 순서 있는 리스트 항목으로 변환하고, 숫자 포함 여부에 따른 공백 규칙을 반영한 Markdown 전처리 로직 추가.
- **유형:** ☑ 변경 ☐ 신규 ☐ 삭제
- **핵심 요구사항:**
  - 입력: LLM 응답 문자열(예: 제공된 응답본문 샘플), 내부 H2 패턴 포함.
  - 출력: H2를 순서형 리스트(`n. 제목`)로 치환한 Markdown 문자열.
  - 예외/제약:
    - 숫자가 있는 H2: 원본 번호를 신뢰, `##` 뒤 공백을 1칸으로 강제 (`##1.제목`/`## 1.제목` → `1. 제목`).
    - 숫자가 없는 H2: `##`를 공백 1칸으로 치환 후 순번을 자동 부여(이전 항목 번호 + 1)하여 `n. 제목` 형태로 변환.
    - 본문/불릿 등 다른 내용은 형태 유지, 불필요한 개행 삽입/삭제 금지.
  - 처리흐름 요약: Markdown 생성 직전에 문자열 전처리 → H2만 감지해 리스트 포맷으로 치환 → 결과 반환.

---

## 2. 구현 대상 파일

| 구분 | 경로 | 설명 |
| ---- | ---- | ---- |
| 변경 | backend/app/utils/markdown_builder.py | Markdown 생성/후처리에 H2→리스트 전처리 함수 추가 |
| 신규 | backend/tests/test_markdown_builder.py | 변환 유닛 테스트 추가(숫자/비숫자 H2, 공백 변종) |

---

## 3. 동작 플로우 (Mermaid)

```mermaid
flowchart TD
    A[LLM 응답 문자열] --> B[postprocess_headings(text)]
```

---

## 4. 테스트 계획

### 4.1 원칙

- 정규식 기반 전처리 단위 테스트 우선.
- 입력 변형 없이 본문/불릿을 보존하는지 스냅샷 검증.
- 숫자/비숫자 H2, 공백 변종, H2 없는 입력을 커버.

### 4.2 구현 예상 테스트 항목

| TC ID | 계층 | 시나리오 | 목적 | 입력/사전조건 | 기대결과 |
| --- | --- | --- | --- | --- | --- |
| TC-UT-001 | Unit | 숫자 H2 붙어 있음 | `##1.제목` → `1. 제목` 변환 | `##1.제목\n내용` | 리스트 포맷, 공백 1칸, 본문 유지 |
| TC-UT-002 | Unit | 숫자 H2 공백 변종 | `## 2 제목` | `## 2 제목\n- bullet` | `2. 제목`으로 변환, 불릿 보존 |
| TC-UT-003 | Unit | 비숫자 H2 | `##제목` | `##제목\n본문` | 순번 자동 부여(`1. 제목` 등), 본문 유지 |
| TC-UT-004 | Unit | H2 없음 | 본문만 있는 경우 | 일반 텍스트 | 변화 없음 |
| TC-UT-005 | Unit | 연속 H2 | H2 여러 개 | `##1.\n##제목\n## 3 제목` | 번호 1,2,3 순서로 변환, 공백 규칙 적용 |

샘플 테스트 코드 위치: `backend/tests/test_markdown_builder.py`

---

## 5. 사용자 요청 프롬프트

**Original User Request (1차):**
```
LLM API 에서 받은 ${응답본문} 에서 ## 과같은 H2 마크다운 언어를 순서가 있는 리스트로 들어갈 수 있도록 하려면 어떻게 해야될까? 우선 계획만 세워줘. (관련 소스코드: backend/app/utils/markdown_builder.py)
```

**User Clarification/Modification (2차+):**
```
요구 정제:
- 숫자가 있는 H2의 경우: 원본 숫자를 신뢰. ##와 텍스트 사이 공백/줄바꿈을 띄어쓰기 한칸으로 변경.
- 숫자가 없는 H2의 경우: ##을 띄어쓰기 한칸으로 변경.
구현 방식: 부하가 적은 방향으로 추천.
```

**최종 명확화 (통합):**
- ✅ H2만 대상으로 정규식 전처리로 리스트 포맷 변환.
- ✅ 숫자 포함 H2: 번호 유지, `##` 뒤 공백 1칸.
- ✅ 숫자 미포함 H2: `##` 제거 후 공백 1칸 + 자동 순번 부여.
- ✅ 본문/불릿 등 나머지 콘텐츠는 원형 유지.
- ✅ 경량 처리(정규식 기반) 우선.

---

**요청 일시:** 2025-11-29

**컨텍스트/배경:**
- LLM 응답을 Markdown → HWP 등 후처리에 사용.
- `backend/app/utils/markdown_builder.py`가 Markdown 생성의 진입점.
